# E2E Testing & Quality Infrastructure

Set up Playwright, create E2E tests that prove user stories and requirements, verify WCAG 2.2 AA compliance, and complete the PDF generation production setup.

## Prerequisites

Before implementing this plan, read and internalise:

1. [`.agent/directives/AGENT.md`](../directives/AGENT.md) — Project context, rules, commands
2. [`.agent/directives/rules.md`](../directives/rules.md) — Core development principles (TDD, no type shortcuts, quality gates)
3. [`.agent/directives/testing-strategy.md`](../directives/testing-strategy.md) — Test types, naming conventions, TDD at all levels
4. [`docs/project/user-stories.md`](../../docs/project/user-stories.md) — The user stories these tests must prove
5. [`docs/project/requirements.md`](../../docs/project/requirements.md) — Non-functional requirements (WCAG 2.2 AA, etc.)

Key conventions from the testing strategy:

- `*.e2e-ui.test.ts` — Browser automation tests (Playwright)
- `*.e2e-api.test.ts` — HTTP-level tests (Playwright request API)
- All E2E tests live in `e2e/` at the project root
- Runner: `pnpm test:e2e`

## Acceptance Criteria

1. Playwright is installed and configured with `pnpm test:e2e`.
2. E2E tests prove each user story in [docs/project/user-stories.md](../../docs/project/user-stories.md).
3. Automated WCAG 2.2 AA checks (axe-core) pass on all pages.
4. PDF-specific E2E tests verify serving, download, and error handling.
5. Vercel Blob store is created and connected (manual step).
6. Production deploy is verified — `/cv/pdf` serves the PDF correctly.
7. Blob management uses the idiomatic `@vercel/blob` approach for Next.js.
8. Quality gates pass: `pnpm check` (format, lint, type-check, test, knip).

---

## Step 0: Vercel Blob Store Setup — Done

**Status:** Complete. The Blob store is created in the Vercel Dashboard and connected to the project. `BLOB_READ_WRITE_TOKEN` is set and available locally via `vercel env pull` (already in `.env.local`).

---

## Step 1: Install and Configure Playwright

| Status | Pending |
| ------ | ------- |

### Dependencies

```bash
pnpm add -D @playwright/test @axe-core/playwright
```

After installing, run `pnpm exec playwright install --with-deps chromium` to download the browser binary.

**Note:** If Playwright's postinstall script is blocked, add `@playwright/test` to `pnpm.onlyBuiltDependencies` in `package.json` (as was needed for `puppeteer`).

### Configuration

Create `playwright.config.ts` at project root:

- Base URL: `http://localhost:3000`
- **Two projects** (see rationale below):
  1. `default` — web server: `pnpm dev` — for UI tests, accessibility, SEO, theme, 404 pages
  2. `with-build` — web server: `pnpm build && pnpm start` — for PDF tests that need a prior build
- Test directory: `e2e/`
- Reporter: HTML (for local) + list (for CI)
- Timeout: 30s per test (default)

**Rationale for two projects:** The PDF route handler serves a file generated by `pnpm build`. In dev mode (`pnpm dev`), the PDF does not exist unless a prior build was run. Rather than requiring a build for all tests, only PDF-related tests (`e2e/pdf.*.test.ts`) use the `with-build` project. All other tests run against the faster dev server.

### Scripts

Add to `package.json`:

```json
"test:e2e": "playwright test",
"test:e2e:ui": "playwright test --ui"
```

**Decision: keep `test:e2e` separate from `pnpm check`.** E2E tests are slower (browser automation, potential build step) and have external dependencies (Chromium). They should be run explicitly, not as part of every pre-commit check. The `pnpm check` script remains: format, lint, type-check, test (Vitest), knip.

### Ignores

Add to `.gitignore`:

```
# Playwright
test-results/
playwright-report/
blob-report/
```

Add to `.prettierignore` (if these directories aren't already covered):

```
test-results/
playwright-report/
```

### Verification

- `pnpm test:e2e` runs successfully (with zero tests initially).
- The `e2e/` directory exists with a README explaining the test structure.

---

## Step 2: E2E Tests for User Stories

| Status | Pending |
| ------ | ------- |

Create Playwright tests that prove the system satisfies each user story. Write tests first (TDD), then verify they pass against the running application.

### Test Plan

| User Story             | Test File                       | Playwright Project | What It Proves                                                             |
| ---------------------- | ------------------------------- | ------------------ | -------------------------------------------------------------------------- |
| US-01: Home page       | `e2e/home.e2e-ui.test.ts`       | default            | Name, tagline, summary visible; CV link navigates correctly                |
| US-02: CV online       | `e2e/cv.e2e-ui.test.ts`         | default            | All CV sections render; content matches JSON; responsive layout            |
| US-03: CV variant      | `e2e/cv-variant.e2e-ui.test.ts` | default            | Variant positioning renders; shared sections unchanged; invalid slug → 404 |
| US-04: PDF download    | `e2e/pdf.e2e-api.test.ts`       | with-build         | `/cv/pdf` returns `application/pdf` with correct headers                   |
| US-05: PDF unavailable | `e2e/pdf.e2e-ui.test.ts`        | default            | `/cv/pdf/unavailable` shows branded 404; link to `/cv` present             |
| US-06: Global 404      | `e2e/not-found.e2e-ui.test.ts`  | default            | Non-existent route → branded 404; link to home                             |
| US-07: Theme toggle    | `e2e/theme.e2e-ui.test.ts`      | default            | Theme toggle cycles Light → Dark → Auto; class applied to `<html>`         |
| US-08: Accessibility   | See Step 3 (WCAG checks)        | default            |                                                                            |
| US-09: SEO             | `e2e/seo.e2e-api.test.ts`       | default            | `<title>`, `<meta description>`, OG tags, sitemap, JSON-LD present         |

### Implementation Notes

- **Content verification** (US-02, US-03): Import the content JSON (`content/cv.content.json`) in the test and assert that rendered text matches. This proves content-driven rendering.
- **PDF download** (US-04): Use Playwright's `request` API to GET `/cv/pdf` and assert `Content-Type: application/pdf`, `Content-Disposition` header, and non-zero body length. This test must run against the `with-build` project.
- **PDF unavailable** (US-05): In the `default` project (dev server, no prior build), navigate to `/cv/pdf`. The route handler should redirect to `/cv/pdf/unavailable`. Assert the branded 404 content and HTTP 404 status.
- **Theme persistence** (US-07): Toggle the theme, navigate to another page, verify the theme persists.
- **SEO** (US-09): Use `request.get()` to fetch pages and parse HTML for meta tags. Check `/sitemap.xml` returns valid XML.

---

## Step 3: WCAG 2.2 AA Compliance Checks

| Status | Pending |
| ------ | ------- |

Use `@axe-core/playwright` to run automated accessibility checks on every page.

### Test File

`e2e/accessibility.e2e-ui.test.ts`

### Pages to Test

| Page            | URL                          | Notes                     |
| --------------- | ---------------------------- | ------------------------- |
| Home            | `/`                          |                           |
| CV (base)       | `/cv`                        |                           |
| CV (variant)    | `/cv/<first-active-variant>` | Test at least one variant |
| PDF unavailable | `/cv/pdf/unavailable`        |                           |
| 404             | `/non-existent-route`        |                           |

### Test Structure

For each page:

1. Navigate to the page.
2. Wait for content to load.
3. Run `new AxeBuilder({ page }).analyze()`.
4. Assert zero violations.
5. **Test in both light and dark themes** (colour contrast differs between themes — see `app/globals.css` CSS custom properties for `:root` and `.dark`).

To switch themes in the test: the site uses `next-themes` with class strategy. Set the theme by adding/removing the `dark` class on `<html>`, or interact with the theme toggle component.

### What axe-core Checks

axe-core covers approximately 30–40% of WCAG criteria automatically:

- Colour contrast ratios (4.5:1 normal text, 3:1 large text)
- Missing alt text, labels, ARIA attributes
- Heading hierarchy
- Landmark regions
- Form element associations
- Focus management
- Link purpose

### Limitations

Automated tooling cannot fully verify:

- Keyboard-only navigation flow
- Screen reader comprehension
- Meaningful reading order
- Complex interaction patterns

These require manual review. The automated checks establish a baseline.

---

## Step 4: Verify Blob Management is Idiomatic

| Status | Pending |
| ------ | ------- |

Review the `@vercel/blob` usage in these two files against the latest SDK documentation:

- `scripts/generate-pdf.ts` — uses `put()` and `head()` with dynamic import
- `app/cv/pdf/route.ts` — uses `head()` + `fetch(meta.url)` to retrieve binary content

**Specific questions to answer:**

1. Is `head()` + `fetch(url)` the recommended way to retrieve blob content, or does the SDK provide a direct `get()` or `download()` method?
2. Is `put()` with `access: "public"` correct for server-side uploads?
3. Should we use `list()` with a prefix instead of `head()` for lookup?
4. Are there any Next.js-specific patterns (e.g. caching, revalidation) we should apply?

**Action:** Read the `@vercel/blob` documentation (use `@Vercel` docs tool or web search), compare with current usage, and either confirm the approach is correct or update the code.

---

## Step 5: Production Deploy and Verify

| Status | Pending |
| ------ | ------- |

1. Deploy to Vercel (push to main or trigger deploy).
2. Vercel runs `pnpm build` → `next build` → `scripts/generate-pdf.ts` → uploads PDF to Blob.
3. Verify: visit `https://jimcresswell.net/cv/pdf` and confirm the PDF displays correctly.
4. Verify: click "Download PDF" on `/cv` and confirm the file downloads.
5. Verify: `/cv/pdf/unavailable` shows the branded 404 (test by temporarily removing the Blob, or on a preview deploy without the token).

---

## Deferred

| Item                                     | Reason                                                              |
| ---------------------------------------- | ------------------------------------------------------------------- |
| Variant PDFs (`/cv/public_sector`, etc.) | Variant strategy is under review — may change or be removed         |
| Stale blob cleanup                       | Not needed until storage costs become relevant                      |
| CI integration for E2E tests             | Set up after local E2E tests are stable                             |
| Performance testing (Lighthouse CI)      | Valuable but lower priority than functional and accessibility tests |

---

## Dependencies

| Dependency             | Version | Purpose                          |
| ---------------------- | ------- | -------------------------------- |
| `@playwright/test`     | latest  | E2E test runner                  |
| `@axe-core/playwright` | latest  | Automated WCAG compliance checks |
